# Orbo Full AI Deployment for Raspberry Pi 4 (8GB recommended)
# Includes YOLO object detection and face recognition
#
# Usage with meta-container-deploy:
#   CONTAINER_MANIFEST = "${THISDIR}/orbo-manifest-full.yaml"
#
# Note: AI inference on CPU is slow (~2-3 FPS). Consider:
#   - Using basic mode for continuous monitoring
#   - Enabling AI only during specific hours
#   - Using Jetson Nano for better AI performance

containers:
  # Main Orbo application
  - name: orbo
    image: ghcr.io/marcopennelli/orbo:latest
    ports:
      - "8080:8080"
    volumes:
      - "/var/lib/orbo/frames:/app/frames:rw"
    devices:
      - "/dev/video0:/dev/video0"
    environment:
      # Detection Pipeline - full AI profile
      # Modes: disabled, visual_only, continuous, motion_triggered, scheduled, hybrid
      # Using motion_triggered to save resources on RPi
      DETECTION_MODE: "motion_triggered"
      # Sequential: YOLO first, then Face if person detected
      DETECTION_EXECUTION_MODE: "sequential"
      # Both YOLO and face detectors enabled
      DETECTION_DETECTORS: "yolo,face"
      DETECTION_SCHEDULE_INTERVAL: "5s"
      # Motion settings
      MOTION_SENSITIVITY: "0.1"
      MOTION_COOLDOWN_SECONDS: "2"
      # Detector services
      YOLO_ENABLED: "true"
      YOLO_ENDPOINT: "http://localhost:8081"
      RECOGNITION_ENABLED: "true"
      RECOGNITION_SERVICE_ENDPOINT: "http://localhost:8082"
      # Storage
      DATABASE_PATH: "/app/frames/orbo.db"
      FRAME_DIR: "/app/frames"
      # Telegram alerts
      TELEGRAM_ENABLED: "false"
      TELEGRAM_COOLDOWN: "60"
      # Legacy (backwards compatibility)
      PRIMARY_DETECTOR: "yolo"
    restart_policy: always
    depends_on:
      - yolo-service
      - recognition
    user: "1000:1000"
    read_only: true

  # YOLO Object Detection Service (Multi-task YOLO11)
  - name: yolo-service
    image: ghcr.io/marcopennelli/orbo-yolo:latest
    ports:
      - "8081:8081"
    environment:
      # Model size: n (nano), s (small), m (medium), l (large), x (xlarge)
      MODEL_SIZE: "n"
      # Higher threshold = fewer detections = faster
      CONFIDENCE_THRESHOLD: "0.6"
      # YOLO11 tasks to enable: detect, pose, segment, obb, classify
      # Use comma-separated list. Each task loads its own model.
      ENABLED_TASKS: "detect,pose"
      # Maximum models to keep in memory (LRU eviction)
      MAX_CACHED_MODELS: "2"
      # Preload models on startup (empty = load on first request)
      PRELOAD_TASKS: "detect"
      # Bounding box customization (hex color format)
      BOX_COLOR: "#0066FF"
      BOX_THICKNESS: "2"
      # Pose estimation settings
      POSE_COLOR: "#FF00FF"
      # Fall detection alert
      FALL_DETECTION: "true"
      ALERT_ON_POSES: "fall_detected,lying"
      # Segmentation settings
      SEGMENT_COLOR: "#00FFFF"
      SEGMENT_ALPHA: "0.4"
      # OBB settings
      OBB_COLOR: "#FFFF00"
    restart_policy: always
    user: "1000:1000"
    read_only: true

  # Face Recognition Service
  - name: recognition
    image: ghcr.io/marcopennelli/orbo-recognition:latest
    ports:
      - "8082:8082"
    volumes:
      # Persistent storage for face database (faces.pkl) and images
      - "/var/lib/orbo/faces:/app/data:rw"
    environment:
      SIMILARITY_THRESHOLD: "0.5"
      # Face database paths (inside container)
      FACES_DB_PATH: "/app/data/faces.pkl"
      FACES_IMAGES_PATH: "/app/data/faces"
      # Bounding box customization (hex color format)
      KNOWN_FACE_COLOR: "#00FF00"
      UNKNOWN_FACE_COLOR: "#FF6600"
      BOX_THICKNESS: "2"
    restart_policy: always
    user: "1000:1000"
    read_only: true
