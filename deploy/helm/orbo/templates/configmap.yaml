apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "orbo.fullname" . }}-config
  labels:
    {{- include "orbo.labels" . | nindent 4 }}
data:
  # Global settings
  log-level: {{ .Values.global.logLevel | quote }}

  # Server configuration
  server-host: {{ .Values.orbo.server.host | quote }}
  server-port: {{ .Values.orbo.server.httpPort | quote }}
  server-debug: {{ .Values.orbo.server.debug | quote }}

  # Telegram notifications
  telegram-enabled: {{ .Values.notifications.telegram.enabled | quote }}
  telegram-cooldown: {{ .Values.notifications.telegram.cooldownSeconds | quote }}

  # ==========================================================================
  # Detection Pipeline Configuration (Global Defaults)
  # ==========================================================================
  # Detection mode: disabled, continuous, motion_triggered, scheduled, hybrid
  detection-mode: {{ .Values.detection.mode | default "motion_triggered" | quote }}

  # Execution mode: sequential or parallel
  detection-execution-mode: {{ .Values.detection.executionMode | default "sequential" | quote }}

  # Enabled detectors (comma-separated list)
  detection-detectors: {{ .Values.detection.detectors | default (list "yolo") | join "," | quote }}

  # Schedule interval for scheduled/hybrid modes
  detection-schedule-interval: {{ .Values.detection.scheduleInterval | default "5s" | quote }}

  # Motion detection settings
  motion-enabled: {{ .Values.detection.motion.enabled | quote }}
  motion-sensitivity: {{ .Values.detection.motion.sensitivity | default 0.1 | quote }}
  motion-cooldown-seconds: {{ .Values.detection.motion.cooldownSeconds | default 2 | quote }}
  motion-min-contour-area: {{ .Values.detection.motion.minContourArea | quote }}
  motion-background-history: {{ .Values.detection.motion.backgroundHistory | quote }}
  motion-var-threshold: {{ .Values.detection.motion.varThreshold | quote }}

  # Legacy detection configuration (backwards compatibility)
  primary-detector: {{ .Values.detection.primaryDetector | default "yolo" | quote }}
  fallback-enabled: {{ .Values.detection.fallbackEnabled | default true | quote }}

  # Storage paths
  frame-store-path: {{ .Values.storage.frames.path | quote }}
  database-path: {{ .Values.storage.database.path | quote }}

  # ==========================================================================
  # Detector Service Endpoints
  # ==========================================================================
  # DINOv3 configuration
  dinov3-enabled: {{ .Values.dinov3.enabled | quote }}
  {{- if .Values.dinov3.enabled }}
  dinov3-endpoint: "http://{{ include "orbo.fullname" . }}-dinov3:{{ .Values.dinov3.service.port }}"
  dinov3-motion-threshold: {{ .Values.dinov3.config.motionThreshold | quote }}
  dinov3-confidence-threshold: {{ .Values.dinov3.config.confidenceThreshold | quote }}
  dinov3-fallback-enabled: {{ .Values.dinov3.config.fallbackToBasic | quote }}
  dinov3-scene-analysis-enabled: {{ .Values.dinov3.config.enableSceneAnalysis | quote }}
  {{- end }}

  # YOLO configuration
  yolo-enabled: {{ .Values.yolo.enabled | quote }}
  {{- if .Values.yolo.enabled }}
  yolo-endpoint: "http://{{ include "orbo.fullname" . }}-yolo:{{ .Values.yolo.service.port }}"
  yolo-confidence-threshold: {{ .Values.yolo.config.confidenceThreshold | quote }}
  yolo-security-mode: {{ .Values.yolo.config.securityMode | quote }}
  yolo-draw-boxes: {{ .Values.yolo.config.drawBoxes | default false | quote }}
  {{- if .Values.yolo.config.classesFilter }}
  yolo-classes-filter: {{ .Values.yolo.config.classesFilter | quote }}
  {{- end }}
  {{- end }}

  # Face Recognition configuration
  recognition-enabled: {{ .Values.recognition.enabled | quote }}
  {{- if .Values.recognition.enabled }}
  recognition-endpoint: "http://{{ include "orbo.fullname" . }}-recognition:{{ .Values.recognition.service.port }}"
  recognition-similarity-threshold: {{ .Values.recognition.config.similarityThreshold | quote }}
  {{- end }}
